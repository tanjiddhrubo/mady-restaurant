<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Analytics ‚Äî Mady Admin</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { primary:"#ea2a33", secondary:"#facc15", dark: "#0f172a" },
          fontFamily: { sans: ["Outfit", "sans-serif"] },
        },
      },
    };
  </script>
  <style>
    body { font-family: 'Outfit', sans-serif; }
    .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .animate-slide-up { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
    .bar { transition: width 0.8s cubic-bezier(0.16, 1, 0.3, 1); }
  </style>
</head>
<body class="bg-slate-50 text-slate-900 flex h-screen overflow-hidden">

  <!-- SIDEBAR MOUNT -->
  <div id="admin-sidebar-root"></div>

  <!-- MAIN CONTENT -->
  <main class="flex-1 flex flex-col min-w-0 overflow-hidden">

    <!-- TOP NAVBAR -->
    <header class="h-20 bg-white sticky top-0 z-40 flex items-center justify-between px-10 border-b border-slate-200">
      <div>
        <h1 class="text-2xl font-black text-slate-900 tracking-tight">Click Analytics</h1>
        <p class="text-xs text-slate-400 font-medium uppercase tracking-widest mt-0.5">FoodPanda Redirect Tracker</p>
      </div>
      <a href="/admin/index.html" class="flex items-center gap-2 text-sm text-slate-500 hover:text-primary transition-colors">
        <span class="material-symbols-outlined text-sm">dashboard</span> Dashboard
      </a>
    </header>

    <!-- CONTENT -->
    <div class="flex-1 overflow-y-auto p-10">
      <div class="max-w-5xl mx-auto space-y-8">

        <!-- KPI TILES -->
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
          <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm flex items-center gap-4">
            <div class="w-12 h-12 rounded-xl bg-primary/10 text-primary flex items-center justify-center">
              <span class="material-symbols-outlined text-2xl">touch_app</span>
            </div>
            <div>
              <p id="stat-total" class="text-3xl font-black">‚Äî</p>
              <p class="text-xs text-slate-400 font-bold uppercase tracking-wider">Total Clicks</p>
            </div>
          </div>
          <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm flex items-center gap-4">
            <div class="w-12 h-12 rounded-xl bg-amber-50 text-amber-500 flex items-center justify-center">
              <span class="material-symbols-outlined text-2xl">restaurant</span>
            </div>
            <div>
              <p id="stat-items" class="text-3xl font-black">‚Äî</p>
              <p class="text-xs text-slate-400 font-bold uppercase tracking-wider">Items Clicked</p>
            </div>
          </div>
          <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm flex items-center gap-4">
            <div class="w-12 h-12 rounded-xl bg-green-50 text-green-500 flex items-center justify-center">
              <span class="material-symbols-outlined text-2xl">trending_up</span>
            </div>
            <div>
              <p id="stat-top" class="text-3xl font-black truncate">‚Äî</p>
              <p class="text-xs text-slate-400 font-bold uppercase tracking-wider">Most Popular Item</p>
            </div>
          </div>
        </div>

        <!-- CHART -->
        <div class="bg-white rounded-2xl border border-slate-100 shadow-sm p-8">
          <h2 class="text-lg font-black mb-6 text-slate-900">Clicks Per Dish</h2>
          <div id="chart" class="space-y-4">
            <div class="flex items-center justify-center py-10 text-slate-300">
              <div class="w-8 h-8 border-4 border-primary/20 border-t-primary rounded-full animate-spin"></div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </main>

  <script type="module" src="/js/admin/sidebar.js"></script>
  <script type="module">
    const API = window.location.origin;

    async function loadAnalytics() {
      const [clickRes, menuRes] = await Promise.all([
        fetch(`${API}/api/analytics/clicks`).then(r => r.json()),
        fetch(`${API}/api/menu`).then(r => r.json()),
      ]);

      const { total_clicks, per_item } = clickRes;
      const menuMap = Object.fromEntries(menuRes.map(i => [String(i.id), i.name]));

      document.getElementById('stat-total').textContent = total_clicks;

      const itemEntries = Object.entries(per_item).filter(([k]) => k !== 'shop');
      document.getElementById('stat-items').textContent = itemEntries.length;

      const sorted = [...itemEntries].sort((a, b) => b[1] - a[1]);
      const topName = sorted[0] ? (menuMap[sorted[0][0]] || 'Shop') : '‚Äî';
      document.getElementById('stat-top').textContent = topName;

      const maxClicks = sorted[0]?.[1] || 1;
      const chart = document.getElementById('chart');

      if (!sorted.length) {
        chart.innerHTML = '<p class="text-center text-slate-400 py-10">No clicks recorded yet. Share your menu to start tracking!</p>';
        return;
      }

      chart.innerHTML = sorted.map(([id, count]) => {
        const name = menuMap[id] || (id === 'shop' ? 'üõç Main Shop' : `Item #${id}`);
        const pct = Math.round((count / maxClicks) * 100);
        return `
          <div class="animate-slide-up">
            <div class="flex items-center justify-between mb-1">
              <span class="text-sm font-bold text-slate-700 truncate flex-1">${name}</span>
              <span class="text-sm font-black text-primary ml-4">${count} click${count !== 1 ? 's' : ''}</span>
            </div>
            <div class="h-3 bg-slate-100 rounded-full overflow-hidden">
              <div class="bar h-full bg-primary rounded-full" style="width: ${pct}%"></div>
            </div>
          </div>`;
      }).join('');
    }

    loadAnalytics();
  </script>
</body>
</html>
